<div class="property-page">
  <div *ngIf="isLoading" class="loading">
    {{ "Loading property details..." | translate }}
  </div>

  <div *ngIf="error" class="error">{{ error }}</div>

  <!-- Rent Request Invitation Section (Agents Only) -->
  <div *ngIf="canCreateInvitations" class="rent-invitation-section">
    <div>
      <h3>{{ "Rent Request Invitation" | translate }}</h3>
      <p>
        {{
          "Send a rent request invitation to a customer for this property"
            | translate
        }}
      </p>
    </div>
    <button
      class="create-invitation-btn"
      (click)="openInvitationModal()"
      type="button"
    >
      {{ "Create Rent Request Invitation" | translate }}
    </button>
  </div>

  <div
    class="property-card"
    *ngIf="property && !isLoading && canReadProperties"
  >
    <!-- property details -->
    <div class="property-details">
      <div class="property-header">
        <span class="property-title">{{
          lang == "ar" ? property.name_ar : property.name_en
        }}</span>
      </div>

      <div class="property-info-grid">
        <!-- Deposit Amount -->
        <div class="property-info-item">
          <img src="/assets/icons/deposit.svg" alt="deposit icon" />
          <div>
            <span class="info-label">{{ "Deposit Amount" | translate }}</span>
            <span class="info-value">
              {{ property.deposit_amount | number }}
              {{ "SAR" | translate }}
            </span>
          </div>
        </div>

        <!-- Annual Rent (Price) -->
        <div class="property-info-item">
          <img src="/assets/icons/fal.svg" alt="rent icon" />
          <div>
            <span class="info-label">{{ "Annual Rent" | translate }}</span>
            <span class="info-value highlight">
              {{ property.annual_rent | number }}
              {{ "SAR" | translate }}
            </span>
          </div>
        </div>

        <!-- Publication Date -->
        <div class="property-info-item">
          <img src="/assets/icons/date-icon.svg" alt="date-icon" />
          <div>
            <span class="info-label">{{ "Posted on" | translate }}</span>
            <span class="info-value">
              {{ property.created_at | date:'yyyy-MM-dd' }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- property images -->
    <div *ngIf="property.images?.length" class="property-images">
      <div *ngFor="let image of property.images" class="property-image">
        <img [src]="image.url" [alt]="property.title + ' image'" />
      </div>
    </div>

    <!-- Agent Information Section -->
    <div *ngIf="property.creator" class="agent-info-section">
      <h3>{{ "Agent Information" | translate }}</h3>
      <div class="agent-info-grid">
        <div class="agent-info-item">
          <span class="info-label">{{ "Agent Name" | translate }}</span>
          <span class="info-value">{{ property.creator.name }}</span>
        </div>
        <div class="agent-info-item">
          <span class="info-label">{{ "Email" | translate }}</span>
          <span class="info-value">{{ property.creator.email }}</span>
        </div>
        <div class="agent-info-item">
          <span class="info-label">{{ "Phone" | translate }}</span>
          <span class="info-value">{{ property.creator.phone_number }}</span>
        </div>
        <div class="agent-info-item">
          <span class="info-label">{{ "Status" | translate }}</span>
          <span class="info-value status-badge" [ngClass]="'status-' + property.creator.agent_status">
            {{ property.creator.agent_status | translate }}
          </span>
        </div>

        <!-- Agent Profile Details -->
        <ng-container *ngIf="property.creator.agent_profile">
          <div class="agent-info-item">
            <span class="info-label">{{ "Agency Name" | translate }}</span>
            <span class="info-value">{{ property.creator.agent_profile.agency_name }}</span>
          </div>
          <div class="agent-info-item">
            <span class="info-label">{{ "Company Registration ID" | translate }}</span>
            <span class="info-value">{{ property.creator.agent_profile.company_registration_id }}</span>
          </div>
          <div class="agent-info-item">
            <span class="info-label">{{ "FAL License Number" | translate }}</span>
            <span class="info-value">{{ property.creator.agent_profile.fal_license_number }}</span>
          </div>
          <div class="agent-info-item" *ngIf="property.creator.agent_profile.fal_document">
            <span class="info-label">{{ "FAL License Document" | translate }}</span>
            <a [href]="property.creator.agent_profile.fal_document" target="_blank" class="document-link">
              {{ "View Document" | translate }}
            </a>
          </div>
          <div class="agent-info-item">
            <span class="info-label">{{ "Agency Address" | translate }}</span>
            <span class="info-value">
              {{ property.creator.agent_profile.agency_address_line_1 }}
              <span *ngIf="property.creator.agent_profile.agency_address_line_2">, {{ property.creator.agent_profile.agency_address_line_2 }}</span>
            </span>
          </div>
          <div class="agent-info-item">
            <span class="info-label">{{ "City" | translate }}</span>
            <span class="info-value">{{ property.creator.agent_profile.city }}</span>
          </div>
          <div class="agent-info-item">
            <span class="info-label">{{ "Country" | translate }}</span>
            <span class="info-value">{{ property.creator.agent_profile.country }}</span>
          </div>
          <div class="agent-info-item">
            <span class="info-label">{{ "Bank Name" | translate }}</span>
            <span class="info-value">{{ property.creator.agent_profile.bank_name }}</span>
          </div>
          <div class="agent-info-item">
            <span class="info-label">{{ "IBAN" | translate }}</span>
            <span class="info-value">{{ property.creator.agent_profile.iban_number }}</span>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- No access message -->
  <div *ngIf="!isLoading && !canReadProperties" class="no-access-message">
    {{ "You don't have permission to view property details" | translate }}
  </div>

  <!-- Rent Request Invitation Modal -->
  <div
    *ngIf="isInvitationModalOpen"
    class="modal-overlay"
    (click)="closeInvitationModal()"
  >
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ "Create Rent Request Invitation" | translate }}</h2>
        <button class="close-button" (click)="closeInvitationModal()">
          <img src="/assets/icons/close-modal-icon.svg" alt="Close" />
        </button>
      </div>

      <div class="modal-body">
        <div class="property-info-summary">
          <h4>
            {{ "Property" | translate }}:
            {{ lang == "ar" ? property.name_ar : property.name_en }}
          </h4>
          <p>
            {{ "Annual Rent" | translate }}:
            {{ property.annual_rent | number }} {{ "SAR" | translate }}
          </p>
        </div>

        <div class="form-group">
          <label for="customerPhone">{{
            "Customer Phone Number" | translate
          }}</label>
          <input
            type="tel"
            id="customerPhone"
            [(ngModel)]="customerPhone"
            [placeholder]="
              'Enter customer phone number (e.g., 05XXXXXXX)' | translate
            "
            class="phone-input"
            [disabled]="isCreatingInvitation"
          />
        </div>

        <div class="modal-actions" *ngIf="!invitationResult">
          <button
            class="cancel-btn"
            (click)="closeInvitationModal()"
            [disabled]="isCreatingInvitation"
          >
            {{ "Cancel" | translate }}
          </button>
          <button
            class="create-btn"
            (click)="createRentRequestInvitation()"
            [disabled]="isCreatingInvitation || !customerPhone.trim()"
            [class.loading]="isCreatingInvitation"
          >
            <span *ngIf="!isCreatingInvitation">{{
              "Create Invitation" | translate
            }}</span>
            <span *ngIf="isCreatingInvitation">{{
              "Creating..." | translate
            }}</span>
          </button>
        </div>

        <!-- Success Result -->
        <div *ngIf="invitationResult" class="invitation-result">
          <h4>{{ "Invitation Created Successfully!" | translate }}</h4>
          <p>{{ "Share this link with the customer:" | translate }}</p>
          <div class="deeplink-container">
            <input
              type="text"
              [value]="invitationResult"
              readonly
              class="deeplink-input"
            />
            <button
              class="copy-btn"
              (click)="copyToClipboard(invitationResult)"
              type="button"
            >
              {{ "Copy" | translate }}
            </button>
          </div>
          <p class="note">
            {{
              "The customer can use this link to submit their rent request for this property."
                | translate
            }}
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
