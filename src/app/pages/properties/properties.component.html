<app-toast></app-toast>
<div class="table" *ngIf="canReadProperties">
  <!-- Table header -->
  <div class="table-header">
    <div class="table-title">{{ "Featured Properties" | translate }}</div>
    <div class="table-search">
      <img src="/assets/icons/search-icon.svg" alt="Search" />
      <input
        type="text"
        [placeholder]="'Search properties' | translate"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
      />
    </div>

    <!-- Add property button -->
    <button
      (click)="createProperty()"
      class="add-property-button"
      *ngIf="userRoleService.isAgent()"
    >
      <span>{{ "Add Property" | translate }}</span>
    </button>
  </div>

  <!-- Filters Section -->
  <div class="filters-container">
    <div class="filters-tab" (click)="toggleFilters()">
      <span class="filters-tab-text">{{ "Filters" | translate }}</span>
      <img
        class="filters-tab-icon"
        [class.rotated]="showFilters"
        src="/assets/icons/arrow-down-icon.svg"
        [alt]="'Toggle filters' | translate"
      />
    </div>

    <div class="table-filters" [class.filters-visible]="showFilters">
      <!-- Category Filter -->
      <div class="filter-group">
        <label>{{ "Category" | translate }}</label>
        <select [(ngModel)]="filters.category_id" (change)="onCategoryChange()">
          <option value="">{{ "All Categories" | translate }}</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ getLocalizedCategoryName(category) }}
          </option>
        </select>
      </div>

      <!-- Type Filter -->
      <div class="filter-group">
        <label>{{ "Type" | translate }}</label>
        <select [(ngModel)]="filters.type_id" (change)="onFilterChange()">
          <option value="">{{ "All Types" | translate }}</option>
          <option *ngFor="let type of filteredTypes" [value]="type.id">
            {{ getLocalizedTypeName(type) }}
          </option>
        </select>
      </div>

      <!-- Price Range -->
      <div class="filter-group">
        <label>{{ "Min Price" | translate }}</label>
        <input
          type="number"
          [(ngModel)]="filters.min_price"
          (input)="onFilterChange()"
          [placeholder]="'Min Price' | translate"
        />
      </div>

      <div class="filter-group">
        <label>{{ "Max Price" | translate }}</label>
        <input
          type="number"
          [(ngModel)]="filters.max_price"
          (input)="onFilterChange()"
          [placeholder]="'Max Price' | translate"
        />
      </div>

      <!-- Bedrooms -->
      <div class="filter-group">
        <label>{{ "Bedrooms" | translate }}</label>
        <select [(ngModel)]="filters.bedrooms" (change)="onFilterChange()">
          <option value="">{{ "Any" | translate }}</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5+</option>
        </select>
      </div>

      <div class="filter-group">
        <!-- Bathrooms -->
        <label>{{ "Bathrooms" | translate }}</label>
        <select [(ngModel)]="filters.bathrooms" (change)="onFilterChange()">
          <option value="">{{ "Any" | translate }}</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5+</option>
        </select>
      </div>

      <!-- Sort By -->
      <div class="filter-group">
        <label>{{ "Sort By" | translate }}</label>
        <select [(ngModel)]="filters.sort_by" (change)="onFilterChange()">
          <option *ngFor="let option of sortOptions" [value]="option.value">
            {{ option.label | translate }}
          </option>
        </select>
      </div>

      <!-- Clear Filters Button -->
      <div class="filter-group">
        <button class="clear-filters-btn" (click)="clearFilters()">
          {{ "Clear Filters" | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- No data -->
  <div class="table-no-data" *ngIf="!loading && properties.length === 0">
    {{ "No data found" | translate }}
  </div>

  <!-- properties -->
  <div class="table-properties">
    <div *ngIf="loading" class="loading-indicator">
      {{ "Loading..." | translate }}
    </div>
    <ng-container *ngIf="!loading">
      <div *ngFor="let item of properties" class="property-item">
        <div class="property-actions">
          <span
            class="action-icon"
            *ngIf="canDeleteProperties"
            (click)="deleteProperty(item.id)"
          >
            <img src="/assets/icons/delete-icon.svg" alt="delete icon" />
          </span>
          <span
            class="action-icon"
            *ngIf="canReadProperties"
            (click)="viewProperty(item.id)"
          >
            <img src="/assets/icons/eye-icon.svg" alt="eye icon" />
          </span>

          <span
            class="action-icon"
            *ngIf="canUpdateProperties"
            (click)="editProperty(item.id)"
          >
            <img src="/assets/icons/edit-icon.svg" alt="edit icon" />
          </span>
        </div>
        <div class="property-details">
          <div class="property-image">
            <img [src]="item.cardImage" alt="property image" />
          </div>
          <div class="property-info">
            <div class="property-info--title">
              <div class="property-title">
                {{ getLocalizedPropertyName(item) }}
              </div>
              <!-- <div class="property-address">
                <img src="/assets/icons/property-location.svg" alt="" />
                <div>{{ item.address.street }}, {{ item.address.city }}</div>
              </div> -->
            </div>

            <div class="property-info--price">
              <div class="property-price">
                <div class="property-annual">
                  {{ "Annual Rent" | translate }}
                </div>
                <div class="property-rent">
                  {{ item.annual_rent | number }}
                  <span>{{ "SAR" | translate }}</span>
                </div>
              </div>

              <div class="property-date" dir="ltr">
                <img src="/assets/icons/date-icon.svg" alt="" />
                <div>
                  {{ item.property_details.posted_date | date : "yyyy-MM-dd" }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Table pagination -->
  <div class="table-pagination">
    <div class="table-pagination--show">
      <span> {{ "Show" | translate }} </span>
      <select [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
        <option [value]="10">10</option>
        <option [value]="20">20</option>
        <option [value]="30">30</option>
      </select>
      <span> {{ "per page" | translate }} </span>
    </div>

    <div class="table-pagination--pages">
      <div class="table-pagination--pages--count">
        {{ (currentPage - 1) * itemsPerPage + 1 }}-{{
          Math.min(currentPage * itemsPerPage, totalItems || properties.length)
        }}

        {{ "of" | translate }}

        {{ totalItems || properties.length }}
      </div>

      <div class="table-pagination--pages--buttons" dir="ltr">
        <button (click)="prevPage()" [disabled]="currentPage === 1">
          <img src="/assets/icons/arrow-left.svg" alt="prev icon" />
        </button>

        <!-- Page numbers -->
        <ng-container
          *ngIf="
            (totalPages ||
              Math.ceil((totalItems || properties.length) / itemsPerPage)) <= 5
          "
        >
          <span
            *ngFor="
              let page of [].constructor(
                totalPages ||
                  Math.ceil((totalItems || properties.length) / itemsPerPage)
              );
              let i = index
            "
            (click)="goToPage(i + 1)"
            [class.active]="currentPage === i + 1"
            class="page-number"
          >
            {{ i + 1 }}
          </span>
        </ng-container>

        <ng-container
          *ngIf="
            (totalPages ||
              Math.ceil((totalItems || properties.length) / itemsPerPage)) > 5
          "
        >
          <!-- First page -->
          <span
            (click)="goToPage(1)"
            [class.active]="currentPage === 1"
            class="page-number"
          >
            1
          </span>

          <!-- Ellipsis if needed -->
          <span *ngIf="currentPage > 3" class="page-ellipsis">...</span>

          <!-- Current page and neighbors -->
          <ng-container *ngFor="let page of getVisiblePages()">
            <span
              (click)="goToPage(page)"
              [class.active]="currentPage === page"
              class="page-number"
            >
              {{ page }}
            </span>
          </ng-container>

          <!-- Ellipsis if needed -->
          <span
            *ngIf="
              currentPage <
              (totalPages ||
                Math.ceil((totalItems || properties.length) / itemsPerPage)) -
                2
            "
            class="page-ellipsis"
            >...</span
          >

          <!-- Last page -->
          <span
            *ngIf="
              (totalPages ||
                Math.ceil((totalItems || properties.length) / itemsPerPage)) > 1
            "
            (click)="
              goToPage(
                totalPages ||
                  Math.ceil((totalItems || properties.length) / itemsPerPage)
              )
            "
            [class.active]="
              currentPage ===
              (totalPages ||
                Math.ceil((totalItems || properties.length) / itemsPerPage))
            "
            class="page-number"
          >
            {{
              totalPages ||
                Math.ceil((totalItems || properties.length) / itemsPerPage)
            }}
          </span>
        </ng-container>

        <button
          (click)="nextPage()"
          [disabled]="
            currentPage >=
            (totalPages ||
              Math.ceil((totalItems || properties.length) / itemsPerPage))
          "
        >
          <img src="/assets/icons/arrow-right.svg" alt="next icon" />
        </button>
      </div>
    </div>
  </div>
</div>

<!-- No access message -->
<div *ngIf="!loading && !canReadProperties" class="no-access-message">
  {{ "You don't have permission to view properties" | translate }}
</div>
