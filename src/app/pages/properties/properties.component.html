<app-toast></app-toast>
<div class="table" *ngIf="canReadProperties">
  <!-- Table header -->
  <div class="table-header">
    <div class="table-title">{{ "Featured Properties" | translate }}</div>
    <div class="table-search">
      <img src="/assets/icons/search-icon.svg" alt="Search" />
      <input
        type="text"
        [placeholder]="'Search properties' | translate"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
      />
    </div>

    <!-- Add property button -->
    <button
      (click)="createProperty()"
      class="add-property-button"
      *ngIf="userRoleService.isAgent()"
    >
      <span>{{ "Add Property" | translate }}</span>
    </button>
  </div>

  <!-- No data -->
  <div class="table-no-data" *ngIf="!loading && properties.length === 0">
    {{ "No data found" | translate }}
  </div>

  <!-- properties -->
  <div class="table-properties">
    <div *ngIf="loading" class="loading-indicator">
      {{ "Loading..." | translate }}
    </div>
    <ng-container *ngIf="!loading">
      <div *ngFor="let item of properties" class="property-item">
        <div class="property-actions">
          <span
            class="action-icon"
            *ngIf="canDeleteProperties"
            (click)="deleteProperty(item.id)"
          >
            <img src="/assets/icons/delete-icon.svg" alt="delete icon" />
          </span>
          <span
            class="action-icon"
            *ngIf="canReadProperties"
            (click)="viewProperty(item.id)"
          >
            <img src="/assets/icons/eye-icon.svg" alt="eye icon" />
          </span>

          <span
            class="action-icon"
            *ngIf="canUpdateProperties"
            (click)="editProperty(item.id)"
          >
            <img src="/assets/icons/edit-icon.svg" alt="edit icon" />
          </span>
        </div>
        <div class="property-details">
          <div class="property-image">
            <img [src]="item.cardImage" alt="property image" />
          </div>
          <div class="property-info">
            <div class="property-info--title">
              <div class="property-title">
                {{ getLocalizedPropertyName(item) }}
              </div>
              <div class="property-address">
                <img src="/assets/icons/property-location.svg" alt="" />
                <div>{{ item.address.street }}, {{ item.address.city }}</div>
              </div>
            </div>

            <div class="property-info--price">
              <div class="property-price">
                <div class="property-annual">
                  {{ "Annual Rent" | translate }}
                </div>
                <div class="property-rent">
                  {{ item.annual_rent | number }}
                  <span>{{ "SAR" | translate }}</span>
                </div>
              </div>

              <div class="property-date" dir="ltr">
                <img src="/assets/icons/date-icon.svg" alt="" />
                <div>
                  {{ item.property_details.posted_date | date : "yyyy-MM-dd" }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Table pagination -->
  <div class="table-pagination">
    <div class="table-pagination--show">
      <span> {{ "Show" | translate }} </span>
      <select [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
        <option [value]="10">10</option>
        <option [value]="20">20</option>
        <option [value]="30">30</option>
      </select>
      <span> {{ "per page" | translate }} </span>
    </div>

    <div class="table-pagination--pages">
      <div class="table-pagination--pages--count">
        {{ (currentPage - 1) * itemsPerPage + 1 }}-{{
          Math.min(currentPage * itemsPerPage, totalItems || properties.length)
        }}

        {{ "of" | translate }}

        {{ totalItems || properties.length }}
      </div>

      <div class="table-pagination--pages--buttons" dir="ltr">
        <button (click)="prevPage()" [disabled]="currentPage === 1">
          <img src="/assets/icons/arrow-left.svg" alt="prev icon" />
        </button>

        <!-- Page numbers -->
        <ng-container
          *ngIf="
            (totalPages ||
              Math.ceil((totalItems || properties.length) / itemsPerPage)) <= 5
          "
        >
          <span
            *ngFor="
              let page of [].constructor(
                totalPages ||
                  Math.ceil((totalItems || properties.length) / itemsPerPage)
              );
              let i = index
            "
            (click)="goToPage(i + 1)"
            [class.active]="currentPage === i + 1"
            class="page-number"
          >
            {{ i + 1 }}
          </span>
        </ng-container>

        <ng-container
          *ngIf="
            (totalPages ||
              Math.ceil((totalItems || properties.length) / itemsPerPage)) > 5
          "
        >
          <!-- First page -->
          <span
            (click)="goToPage(1)"
            [class.active]="currentPage === 1"
            class="page-number"
          >
            1
          </span>

          <!-- Ellipsis if needed -->
          <span *ngIf="currentPage > 3" class="page-ellipsis">...</span>

          <!-- Current page and neighbors -->
          <ng-container *ngFor="let page of getVisiblePages()">
            <span
              (click)="goToPage(page)"
              [class.active]="currentPage === page"
              class="page-number"
            >
              {{ page }}
            </span>
          </ng-container>

          <!-- Ellipsis if needed -->
          <span
            *ngIf="
              currentPage <
              (totalPages ||
                Math.ceil((totalItems || properties.length) / itemsPerPage)) -
                2
            "
            class="page-ellipsis"
            >...</span
          >

          <!-- Last page -->
          <span
            *ngIf="
              (totalPages ||
                Math.ceil((totalItems || properties.length) / itemsPerPage)) > 1
            "
            (click)="
              goToPage(
                totalPages ||
                  Math.ceil((totalItems || properties.length) / itemsPerPage)
              )
            "
            [class.active]="
              currentPage ===
              (totalPages ||
                Math.ceil((totalItems || properties.length) / itemsPerPage))
            "
            class="page-number"
          >
            {{
              totalPages ||
                Math.ceil((totalItems || properties.length) / itemsPerPage)
            }}
          </span>
        </ng-container>

        <button
          (click)="nextPage()"
          [disabled]="
            currentPage >=
            (totalPages ||
              Math.ceil((totalItems || properties.length) / itemsPerPage))
          "
        >
          <img src="/assets/icons/arrow-right.svg" alt="next icon" />
        </button>
      </div>
    </div>
  </div>
</div>

<!-- No access message -->
<div *ngIf="!loading && !canReadProperties" class="no-access-message">
  {{ "You don't have permission to view properties" | translate }}
</div>
