<!-- Add Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<form [formGroup]="propertyForm" (ngSubmit)="onSubmit()">
  <app-toast></app-toast>
  <!-- Basic Information -->
  <section>
    <h3>{{ "Basic Information" | translate }}</h3>
    <div class="section-content grid-3">
      <div class="input-group">
        <label>{{ "Property Name" | translate }}</label>
        <input
          formControlName="propertyName"
          type="text"
          placeholder="{{ 'Enter property name' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('propertyName')?.errors?.['required'] && propertyForm.get('propertyName')?.touched"
        >
          {{ "Property name is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Property Name (Arabic)" | translate }}</label>
        <input
          formControlName="propertyNameAr"
          type="text"
          placeholder="{{ 'Enter property name in Arabic' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('propertyNameAr')?.errors?.['required'] && propertyForm.get('propertyNameAr')?.touched"
        >
          {{ "Property name is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Property Category" | translate }}</label>
        <select formControlName="propertyCategory" [disabled]="isLoading">
          <option value="">{{ "Select Category" | translate }}</option>
          <option
            *ngFor="let category of propertyCategories"
            [value]="category.id"
          >
            {{ getLocalizedCategoryName(category) }}
          </option>
        </select>
        <div
          *ngIf="propertyForm.get('propertyCategory')?.errors?.['required'] && propertyForm.get('propertyCategory')?.touched"
        >
          {{ "Property category is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Property Type" | translate }}</label>
        <select
          formControlName="propertyType"
          [disabled]="!propertyForm.get('propertyCategory')?.value || isLoading"
        >
          <option value="">{{ "Select Type" | translate }}</option>
          <option *ngFor="let type of filteredPropertyTypes" [value]="type.id">
            {{ getLocalizedPropertyTypeName(type) }}
          </option>
        </select>
        <div
          *ngIf="propertyForm.get('propertyType')?.errors?.['required'] && propertyForm.get('propertyType')?.touched"
        >
          {{ "Property type is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Property Size (m²)" | translate }}</label>
        <input
          formControlName="propertySize"
          type="number"
          placeholder="{{ 'Enter property size' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('propertySize')?.errors?.['required'] && propertyForm.get('propertySize')?.touched"
        >
          {{ "Property size is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Available From" | translate }}</label>
        <input
          formControlName="availableFrom"
          type="date"
          placeholder="{{ 'Select available date' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('availableFrom')?.errors?.['required'] && propertyForm.get('availableFrom')?.touched"
        >
          {{ "Available date is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Furnishment" | translate }}</label>
        <select formControlName="furnishment">
          <option value="">{{ "Select Furnishment" | translate }}</option>
          <option value="furnished">{{ "Furnished" | translate }}</option>
          <option value="unfurnished">{{ "Unfurnished" | translate }}</option>
          <option value="semi-furnished">
            {{ "Semi-furnished" | translate }}
          </option>
        </select>
        <div
          *ngIf="propertyForm.get('furnishment')?.errors?.['required'] && propertyForm.get('furnishment')?.touched"
        >
          {{ "Furnishment is required" | translate }}
        </div>
      </div>
    </div>
  </section>

  <!-- Property Details -->
  <section>
    <h3>{{ "Property Details" | translate }}</h3>

    <div class="section-content grid-3">
      <div class="input-group">
        <label>{{ "Number of Bedrooms" | translate }}</label>
        <input
          formControlName="bedrooms"
          type="number"
          placeholder="{{ 'Enter number of bedrooms' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('bedrooms')?.errors?.['required'] && propertyForm.get('bedrooms')?.touched"
        >
          {{ "Number of bedrooms is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Number of Bathrooms" | translate }}</label>
        <input
          formControlName="bathrooms"
          type="number"
          placeholder="{{ 'Enter number of bathrooms' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('bathrooms')?.errors?.['required'] && propertyForm.get('bathrooms')?.touched"
        >
          {{ "Number of bathrooms is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Floor Number" | translate }}</label>
        <input
          formControlName="floorNumber"
          type="number"
          placeholder="{{ 'Enter floor number' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('floorNumber')?.errors?.['required'] && propertyForm.get('floorNumber')?.touched"
        >
          {{ "Floor number is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Total Floors" | translate }}</label>
        <input
          formControlName="totalFloors"
          type="number"
          placeholder="{{ 'Enter total number of floors' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('totalFloors')?.errors?.['required'] && propertyForm.get('totalFloors')?.touched"
        >
          {{ "Total floors is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Annual Rent (SAR)" | translate }}</label>
        <input
          formControlName="annualRent"
          type="number"
          placeholder="{{ 'Enter annual rent amount' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('annualRent')?.errors?.['required'] && propertyForm.get('annualRent')?.touched"
        >
          {{ "Annual rent is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Deposit Amount" | translate }}</label>
        <input
          formControlName="depositAmount"
          type="number"
          placeholder="{{ 'Enter deposit amount' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('depositAmount')?.errors?.['required'] && propertyForm.get('depositAmount')?.touched"
        >
          {{ "Deposit amount is required" | translate }}
        </div>
      </div>
      <div class="input-group text-area">
        <label>{{ "Property Description" | translate }}</label>
        <textarea
          formControlName="description"
          placeholder="{{ 'Enter property description' | translate }}"
        ></textarea>
        <div
          *ngIf="propertyForm.get('description')?.errors?.['required'] && propertyForm.get('description')?.touched"
        >
          {{ "Property description is required" | translate }}
        </div>
      </div>
      <div class="input-group text-area">
        <label>{{ "Property Description (Arabic)" | translate }}</label>
        <textarea
          formControlName="descriptionAr"
          placeholder="{{ 'Enter property description in Arabic' | translate }}"
        ></textarea>
        <div
          *ngIf="propertyForm.get('descriptionAr')?.errors?.['required'] && propertyForm.get('descriptionAr')?.touched"
        >
          {{ "Property description is required" | translate }}
        </div>
      </div>
    </div>
  </section>

  <!-- Location Details -->
  <section>
    <h3>{{ "Location Details" | translate }}</h3>
    <div class="section-content grid-2">
      <div class="input-group">
        <label>{{ "Address Line 1" | translate }}</label>
        <input
          formControlName="addressLine1"
          type="text"
          placeholder="{{ 'Enter address line 1' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('addressLine1')?.errors?.['required'] && propertyForm.get('addressLine1')?.touched"
        >
          {{ "Address is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Building Name" | translate }}</label>
        <input
          formControlName="buildingName"
          type="text"
          placeholder="{{ 'Enter building name' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('buildingName')?.errors?.['required'] && propertyForm.get('buildingName')?.touched"
        >
          {{ "Building name is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Province" | translate }}</label>
        <select formControlName="province">
          <option value="">{{ "Select Province" | translate }}</option>
          <option value="riyadh">{{ "Riyadh" | translate }}</option>
          <option value="jeddah">{{ "Jeddah" | translate }}</option>
          <option value="dammam">{{ "Dammam" | translate }}</option>
          <!-- Add more provinces as needed -->
        </select>
        <div
          *ngIf="propertyForm.get('province')?.errors?.['required'] && propertyForm.get('province')?.touched"
        >
          {{ "Province is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Postal Code" | translate }}</label>
        <input
          formControlName="postalCode"
          type="text"
          placeholder="{{ 'Enter postal code' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('postalCode')?.errors?.['required'] && propertyForm.get('postalCode')?.touched"
        >
          {{ "Postal code is required" | translate }}
        </div>
      </div>
      <div class="map-container">
        <div
          id="property-map"
          style="height: 405px; width: 100%; border-radius: 8px"
        ></div>
      </div>
    </div>
  </section>

  <!-- Property Images -->
  <section>
    <h3>{{ "Property Images" | translate }}</h3>
    <div class="section-content">
      <div class="file-input-container">
        <div class="upload-area">
          <div
            *ngIf="imageUploadError"
            class="error-message error-grid-span"
            style="margin-bottom: 10px"
          >
            {{ imageUploadError }}
          </div>
          <img
            src="assets/icons/file-upload.svg"
            alt="{{ 'file-upload' | translate }}"
          />
          <p>
            {{
              "Drag and drop your images here, or click to select files"
                | translate
            }}
          </p>
          <span>{{ "PNG, JPG up to 10MB each" | translate }}</span>
          <button
            type="button"
            class="upload-button"
            (click)="fileInput.click()"
          >
            {{ "Select Files" | translate }}
          </button>
          <input
            #fileInput
            type="file"
            formControlName="images"
            multiple
            accept="image/*"
            style="display: none"
            (change)="onFileSelected($event)"
          />
        </div>

        <div class="uploaded-files" *ngIf="uploadedFiles.length > 0">
          <h4>{{ "Uploaded Files" | translate }}</h4>
          <div class="file-list">
            <div class="file-item" *ngFor="let file of uploadedFiles">
              <span class="file-name">{{ file.name }}</span>
              <span class="file-size"
                >({{ formatFileSize(file.size) }}
                {{ "File Size" | translate }})</span
              >
              <button
                type="button"
                class="remove-file"
                (click)="removeFile(file)"
                [attr.aria-label]="'Remove' | translate"
              >
                ×
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Property Features -->
  <section>
    <h3>{{ "Property Features" | translate }}</h3>
    <div class="section-content grid-5 feature-buttons">
      <label
        class="feature-button"
        [class.active]="propertyForm.get('amenity_' + amenity.id)?.value"
        *ngFor="let amenity of propertyAmenities"
        [attr.for]="'amenity_' + amenity.id"
      >
        <input
          type="checkbox"
          [formControlName]="'amenity_' + amenity.id"
          class="hidden-checkbox"
          [id]="'amenity_' + amenity.id"
        />
        <span class="button-content">
          <!-- <img
            [src]="getAmenityIcon(amenity.icon)"
            [alt]="amenity.name_en"
            (error)="onImageError($event)"
          /> -->
          {{ getLocalizedAmenityName(amenity) }}
        </span>
      </label>
    </div>
    <h2>{{ "Nearby Features" | translate }}</h2>
    <div class="section-content grid-6">
      <div class="input-group" *ngFor="let amenity of distanceAmenities">
        <label>{{ getLocalizedAmenityName(amenity) }}</label>
        <input
          [formControlName]="'distance_' + amenity.id"
          type="text"
          [placeholder]="'Distance (KM)' | translate"
        />
      </div>
    </div>
  </section>

  <!-- Legal Information -->
  <section>
    <h3>{{ "Legal Information" | translate }}</h3>
    <div class="section-content grid-2">
      <div class="input-group">
        <label>{{ "FAL License ID" | translate }}</label>
        <input
          formControlName="falLicenseId"
          type="text"
          placeholder="{{ 'Enter FAL license ID' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('falLicenseId')?.errors?.['required'] && propertyForm.get('falLicenseId')?.touched"
        >
          {{ "FAL License ID is required" | translate }}
        </div>
      </div>
      <div class="input-group">
        <label>{{ "Advertising License No" | translate }}</label>
        <input
          formControlName="advertisingLicenseNo"
          type="text"
          placeholder="{{ 'Enter advertising license number' | translate }}"
        />
        <div
          *ngIf="propertyForm.get('advertisingLicenseNo')?.errors?.['required'] && propertyForm.get('advertisingLicenseNo')?.touched"
        >
          {{ "Advertising License No is required" | translate }}
        </div>
      </div>
      <div class="confirmation-checkbox">
        <label>
          <input type="checkbox" formControlName="declaration" />
          {{
            "I hereby declare that the information furnished above is true, complete, and correct to the best of my knowledge and belief."
              | translate
          }}
        </label>
        <div
          class="error-message"
          *ngIf="propertyForm.get('declaration')?.errors?.['required'] && propertyForm.get('declaration')?.touched"
        >
          {{ "You must accept the declaration" | translate }}
        </div>
      </div>

      <!-- errors -->
      <div
        *ngIf="backendError || backendFieldErrors"
        class="error-message error-grid-span"
        style="margin-bottom: 10px"
      >
        <!-- Only show field errors, not the main backendError message -->
        <ul
          *ngIf="backendFieldErrors && (backendFieldErrors | keyvalue).length"
          dir="ltr"
        >
          <li *ngFor="let err of backendFieldErrors | keyvalue">
            <strong>{{ formatFieldName(err.key) }}:</strong>
            <span *ngFor="let msg of err.value; let last = last">
              {{ msg }}<span *ngIf="!last">, </span>
            </span>
          </li>
        </ul>
      </div>
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button type="button" (click)="onCancel()">
          {{ "Cancel" | translate }}
        </button>
        <button type="button" (click)="onSaveDraft()">
          {{ "Save as Draft" | translate }}
        </button>
        <button type="submit">
          <span *ngIf="isLoading">{{ "Loading..." | translate }}</span>
          <span *ngIf="!isLoading">{{ "Submit Property" | translate }}</span>
        </button>
      </div>
    </div>
  </section>
</form>
